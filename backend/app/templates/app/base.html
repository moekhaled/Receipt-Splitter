{% load static %}
<meta name="viewport" content="width=device-width, initial-scale=1">

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'app/styles.css' %}">
</head>

<!-- AI Assistant -->
<div id="ai-assistant" class="ai-assistant" data-open="false">
  <button id="ai-toggle" class="ai-toggle" aria-label="Open AI Assistant" aria-expanded="false">
    ‚ú®
  </button>

  <!-- dim background on mobile -->
  <div id="ai-overlay" class="ai-overlay" hidden></div>

  <div
    id="ai-panel"
    class="ai-panel"
    role="dialog"
    aria-modal="true"
    aria-labelledby="ai-title"
    aria-hidden="true"
  >
    <div id="ai-header" class="ai-header">
      <span id="ai-title" class="ai-title">AI Assistant</span>
      <button id="ai-close" class="ai-close" type="button" aria-label="Close">√ó</button>
    </div>

    <div id="ai-messages" class="ai-messages">
      <div class="ai-message">
        
        {% include "app/_ai_messages.html" with history=request.session.ai_chat_history %}

      </div>
    </div>

    <form id="ai-form" class="ai-form" data-ai-url="/ai/parse/"
      data-session-id="{% if session %}{{ session.pk }}{% endif %}">
      {% csrf_token %}  
      <textarea
        id="ai-input"
        class="ai-input"
        placeholder="Create a new receipt with 14% VAT..."
        rows="2"
      ></textarea>
      <button class="ai-send" type="submit">Send</button>
    </form>
  </div>
</div>


<body>


<header id="main-header">
    <nav id="main-nav">
        <a href="{% url 'all-sessions' %}" class="nav-button" >All Receipts</a>
        {% block header_extras %}{% endblock %}
    </nav>
</header>

<main id="main-content">
    {% block content %}{% endblock %}
</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // =========================
  // AI Assistant Elements
  // =========================
  const toggleBtn = document.getElementById("ai-toggle");
  const panel = document.getElementById("ai-panel");
  const closeBtn = document.getElementById("ai-close");
  const form = document.getElementById("ai-form");
  const input = document.getElementById("ai-input");
  const messages = document.getElementById("ai-messages");

  // Build history from the already-rendered DOM (server session history)
const loadHistoryFromDOM = () => {
  const items = [];
  const nodes = messages.querySelectorAll(".ai-message");
  nodes.forEach((node) => {
    const isUser = node.classList.contains("user");
    const bubble = node.querySelector(".ai-bubble");
    if (!bubble) return;

    const text = (bubble.textContent || "").trim();
    if (!text) return;

    items.push({
      role: isUser ? "user" : "assistant",
      content: text,
    });
  });
  return items;
};

const chatHistory = loadHistoryFromDOM();


  input?.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();              // don't insert newline
      form?.requestSubmit();           // triggers your existing submit handler
    }
  });
  
  // ‚úÖ CHANGED: read URL from data attribute (already in your HTML)
  const aiUrl = form?.dataset.aiUrl;

  // ‚úÖ ADDED: helper to keep code DRY
  const scrollToBottom = () => {
    messages.scrollTop = messages.scrollHeight;
  };

  // ‚úÖ ADDED: helper to append chat bubbles
  const addMessage = (text, who = "bot") => {

    const wrapper = document.createElement("div");
    wrapper.classList.add("ai-message", who);

    const bubble = document.createElement("div");
    bubble.classList.add("ai-bubble");
    bubble.textContent = text;

    wrapper.appendChild(bubble);
    messages.appendChild(wrapper);
    scrollToBottom();

    const role = (who === "user") ? "user" : "assistant";
    chatHistory.push({ role, content: text });

    // keep last 24 messages (12 turns) to avoid huge prompts
    if (chatHistory.length > 24) chatHistory.splice(0, chatHistory.length - 24);

    return wrapper;
};

  // ‚úÖ ADDED: read CSRF token from the hidden form input
  const getCsrfToken = () =>
    document.querySelector('#ai-form input[name="csrfmiddlewaretoken"]')?.value || "";

  // ‚úÖ ADDED: prime CSRF cookie for fresh browsers (mobile)
  fetch("/ai/csrf/", { credentials: "same-origin" });

  // =========================
  // Panel Open / Close
  // =========================
  toggleBtn?.addEventListener("click", () => {
    panel.classList.toggle("open");
    if (panel.classList.contains("open")) input?.focus();
  });

  closeBtn?.addEventListener("click", () => {
    panel.classList.remove("open");
  });

  // =========================
  // Submit Handler
  // =========================
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const text = input.value.trim();
    if (!text) return;

    // ‚úÖ CHANGED: use helper
    addMessage(text, "user");

    // ‚úÖ CHANGED: clear input immediately
    input.value = "";

    // ‚úÖ ADDED: simple loading bubble
    const loadingBubble = addMessage("ü§ñ Thinking...", "bot");
    const payload = { prompt: text, history: chatHistory };
    const sessionId = form.dataset.sessionId;
    if (sessionId) payload.context = { session_id: Number(sessionId) };

    try {
      const csrfToken = getCsrfToken();

      const response = await fetch(aiUrl, {
        method: "POST",
        credentials: "same-origin", // ‚úÖ ADDED: important for CSRF cookie on mobile
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify(payload),
      });

      let data = {};
      try {
        data = await response.json();
      } catch (_) {
        // response isn't JSON
      }

      // remove loading bubble before showing final message
      loadingBubble.remove();

      if (!response.ok) {
        addMessage(data.response || `‚ùå Request failed (${response.status})`, "bot");
        return;
      }

      addMessage(data.response || "Sorry, I couldn‚Äôt process that.", "bot");

      // ‚úÖ Persist to backend session history (so refresh keeps chat)
      try {
        await fetch("/api/ai/history/append/", {
          method: "POST",
          credentials: "same-origin",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken,
          },
          body: JSON.stringify({
            user: text,
            bot: (data.response || "Sorry, I couldn‚Äôt process that."),
          }),
        });
      } catch (_) {
        // Don't block the UX if saving history fails
      }

      // optional redirect support (if backend returns it)
      if (data.action === "redirect" && data.redirect_url) {
        window.location.href = data.redirect_url;
      }

    } catch (err) {
      console.error(err);
      // remove loading bubble if request failed
      loadingBubble.remove();
      addMessage("‚ùå Error sending request. Try again.", "bot");
    }
  });

});
</script>



</body>

</html>

